# Insurance Cycles Experimental Framework

This document explains how to run experiments and analyze results for the `insurance_cycles` module.

## Overview

The experimental framework enables:
- **Batch simulations**: Run multiple Monte Carlo simulations with different seeds
- **Parameter sweeps**: Systematically vary model parameters (Î², z, Î³, leverage)
- **Statistical validation**: Verify cycle emergence, AR(2) properties, stationarity
- **Automated analysis**: Python scripts for cycle detection, visualization, and anomaly detection

## Running Experiments

### 1. Quick Test (2 runs, 50 years)

```bash
cargo run --release --bin run_experiment -- experiments/test_quick.toml
```

### 2. Baseline Validation (30 runs, 100 years)

Validates the model against Owadally et al. (2018) findings:

```bash
cargo run --release --bin run_experiment -- experiments/baseline_validation.toml
```

Expected results:
- Cycle detection rate: â‰¥95%
- Mean loss ratio: 0.95 - 1.05
- Cycle period: 2.5 - 7.0 years (paper reports ~5.9 years)
- AR(2) conditions met: â‰¥80%

### 3. Parameter Sensitivity Sweeps

#### Beta Sweep (Î² âˆˆ [0.1, 1.0])

Tests underwriter smoothing impact on cycles:

```bash
cargo run --release --bin run_experiment -- experiments/beta_sensitivity.toml
```

Expected relationships:
- Î² â†‘ â†’ cycle_period â†“ (negative correlation)
- Î² â†‘ â†’ std_loss_ratio â†‘ (more volatile)
- Î² = 1.0 â†’ cycles disappear (white noise)

#### Other Sweeps

```bash
# Credibility factor (z)
cargo run --release --bin run_experiment -- experiments/credibility_sweep.toml

# Distance cost (Î³) - affects market concentration
cargo run --release --bin run_experiment -- experiments/distance_cost_sweep.toml

# Leverage ratio - capacity constraints
cargo run --release --bin run_experiment -- experiments/leverage_sensitivity.toml
```

## Output Structure

```
results/
â””â”€â”€ experiment_name/
    â”œâ”€â”€ run_100/
    â”‚   â”œâ”€â”€ market_timeseries.csv       # Year-by-year market data
    â”‚   â”œâ”€â”€ insurer_snapshots.csv       # Per-insurer snapshots
    â”‚   â””â”€â”€ summary.json                # Metadata + cycle metrics
    â”œâ”€â”€ run_101/
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ aggregate_summary.json          # Statistics across all runs
    â””â”€â”€ cycle_diagnostics.png           # (generated by Python analysis)
```

### Output Files

#### market_timeseries.csv

Columns:
- `year`: Simulation year
- `loss_ratio`: Claims / Premiums
- `avg_claim`: Average claim amount
- `total_premiums`, `total_claims`: Industry aggregates
- `avg_price`, `min_price`, `max_price`: Price distribution
- `num_solvent_insurers`: Solvency count
- `herfindahl_index`: Market concentration (HHI)
- `gini_coefficient`: Market inequality

#### insurer_snapshots.csv

Columns:
- `year`: Snapshot year
- `insurer_id`: Insurer identifier
- `capital`: Current capital
- `market_share`: Fraction of customers (0-1)
- `price`: Market price
- `markup`: Underwriter markup
- `loss_ratio`: Individual loss ratio
- `num_customers`: Customer count
- `is_solvent`: Solvency status

#### summary.json

Contains:
- `metadata`: Config, seed, timestamp, git commit
- `cycle_metrics`: has_cycles, cycle_period, AR(2) coefficients, etc.

#### aggregate_summary.json

Statistics across all runs:
- Cycle detection rate
- Mean/std of loss ratios, cycle periods
- AR(2) coefficient distributions
- Cycle condition success rate

## Python Analysis

### Setup

```bash
cd insurance_cycles/analysis
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### Cycle Analysis

Analyze cycle detection, AR(2) fitting, spectral analysis:

```bash
python cycle_analysis.py ../results/baseline_validation/
```

Output:
- Prints aggregate statistics
- Generates `cycle_diagnostics.png` with 4 panels:
  1. Time series with detected peaks
  2. Autocorrelation function (ACF)
  3. Partial autocorrelation function (PACF)
  4. Periodogram with dominant frequency

### Anomaly Detection

(To be implemented - see tasks #10)

Verify:
- Shadow state consistency (Î£ insurer totals = market totals)
- Capacity constraint violations
- Insolvency rates (<20% threshold)
- Loss ratio explosions (>2.0)
- Stationarity (Augmented Dickey-Fuller test)

### Market Structure Analysis

(To be implemented - see task #11)

Analyze:
- Herfindahl index (HHI) evolution
- Gini coefficient trends
- Market share concentration
- Dominant firm emergence

### Parameter Sensitivity Analysis

(To be implemented - see task #12)

Analyze sweep results:
- Load all runs from parameter sweep
- Aggregate metrics per parameter value
- Plot sensitivity curves with confidence bands
- Statistical significance tests (ANOVA, Tukey HSD)

## Interpreting Results

### Success Criteria (Baseline Configuration)

âœ… **Cycles emerge**:
- `has_cycles() == true` in â‰¥95% of runs
- At least 3 sign changes in loss ratio first differences

âœ… **Loss ratio stationarity**:
- Mean: 0.95 â‰¤ Î¼ â‰¤ 1.05
- Augmented Dickey-Fuller test: p < 0.05

âœ… **Cycle period reasonable**:
- Peak-to-peak: 2.5 â‰¤ T â‰¤ 7.0 years
- Implementation: ~3.1 years (shorter than paper's 5.9 years, expected due to simplifications)

âœ… **AR(2) conditions** (Owadally et al. 2018):
- a1 > 0 (positive feedback)
- -1 < a2 < 0 (damped oscillation)
- a1Â² + 4a2 < 0 (complex roots â†’ cyclical behavior)
- Met in â‰¥80% of runs

âœ… **Market stability**:
- â‰¥90% insurers solvent at end
- No loss_ratio > 2.0 (extreme values)

âœ… **Shadow state consistency**:
- |Î£(insurer.claims) - market.cumulative_claims| / market.cumulative_claims < 3%

### Known Discrepancies

**Cycle Period**: Implementation shows ~3.1 year cycles vs. paper's 5.9 years (-47% divergence)

Possible causes:
- Deterministic customer allocation (no switching costs/noise)
- Simplified market structure (customers as data, not agents)
- Missing feedback mechanisms from the paper

**Investigation**: Use beta_sensitivity sweep to understand how Î² affects period

### Anomalies to Watch For

ðŸš¨ **Mass insolvencies** (>20% insolvent):
- Indicates parameter misconfiguration
- Check leverage_ratio, initial_capital

ðŸš¨ **Shadow state divergence** (>3%):
- Suggests event processing bug
- Verify MarketCoordinator's capital tracking

ðŸš¨ **Cycle disappearance** for Î² âˆˆ [0.2, 0.4]:
- Implementation regression
- Cycles should exist for low Î² values

ðŸš¨ **Loss ratio explosions** (>2.0):
- Pricing or claim generation bug
- Check actuarial_price calculation

## Creating Custom Experiments

### Experiment Config Template

```toml
[experiment]
name = "my_experiment"
description = "Description of what this tests"
num_runs = 10
num_years = 100
warmup_years = 20
base_seed = 5000

[model]
# All ModelConfig parameters
risk_loading_factor = 0.001
underwriter_smoothing = 0.3  # Can be omitted if using sweep
# ... (see baseline_validation.toml for full list)

# Optional: parameter sweep
[sweep]
parameter = "underwriter_smoothing"
values = [0.1, 0.2, 0.3, 0.4, 0.5]

[output]
save_market_timeseries = true
save_insurer_snapshots = true
save_summary_stats = true
snapshot_interval = 5
```

### Supported Sweep Parameters

- `underwriter_smoothing` (Î²) - Critical for cycle dynamics
- `credibility_factor` (z) - Own experience vs. industry weight
- `distance_cost` (Î³) - Customer preference sensitivity
- `leverage_ratio` - Capacity constraint tightness

## Troubleshooting

### Experiment runner fails with "Error parsing TOML"

- Check TOML syntax (commas, quotes, brackets)
- Ensure all required fields are present
- Validate with: `cargo run --bin run_experiment -- experiments/test_quick.toml`

### Python analysis crashes with import errors

- Activate virtual environment: `source venv/bin/activate`
- Install dependencies: `pip install -r requirements.txt`
- Verify Python version: `python --version` (requires â‰¥3.8)

### Cycles not detected despite Î²=0.3

- Check simulation length: need â‰¥50 years for reliable detection
- Verify loss_ratio_history in summary.json is not empty
- Inspect market_timeseries.csv for actual loss ratio values

### Aggregate summary missing runs

- Check that run directories contain summary.json
- Verify no simulation crashes (check stderr output)
- Increase timeout if simulations are slow

## Performance Notes

- **Baseline validation** (30 runs Ã— 100 years): ~1-2 minutes
- **Beta sweep** (100 runs Ã— 100 years): ~8-10 minutes
- **Memory usage**: ~50MB per run (negligible)

Optimization:
- Use `--release` mode for 10-20Ã— speedup
- Run parameter sweeps in parallel (future: thread pool)
- Reduce `num_years` for quick prototyping

## Next Steps

See the plan document for:
- Full Python analysis suite implementation (tasks #10-13)
- Baseline experiment execution and validation (tasks #14-15)
- Parameter sensitivity experiments (task #16)

## References

- Owadally, I., Zhou, F., & Wright, D. (2018). *The insurance industry as a complex social system: competition, cycles and regulation*. Risks, 6(4), 138.
- AR(2) cycle conditions: Section 3.2, Equations 9-11
- Parameter sensitivity: Section 4, Figures 2-4
